<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>THE ICONE - Etiket ve Barkod Oluşturucu</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      gap: 30px;
      align-items: flex-start;
    }
    .container, .preview-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      flex: 1;
      max-width: 400px;
    }
    /* Removed h1 styling as it's replaced by a logo */
    h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 18px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .main-logo-container {
      text-align: center;
      margin-bottom: 25px; /* Adjusted margin for logo */
    }
    .main-logo-container img {
      max-height: 50px; /* Adjusted max-height for main logo */
      width: auto;
    }
    .form-group { margin-bottom: 20px; }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    .preview-btn { background: linear-gradient(45deg, #3498db, #2980b9); margin-bottom: 10px; }
    .print-btn   { background: linear-gradient(45deg, #27ae60, #2ecc71); }
    .bulk-btn    { background: linear-gradient(45deg, #e74c3c, #c0392b); }
    .download-btn { background: linear-gradient(45deg, #f39c12, #e67e22); }

    /* File input styling */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
      margin-bottom: 10px;
    }
    .file-input {
      position: absolute;
      left: -9999px;
    }
    .file-input-label {
      background: linear-gradient(45deg, #9b59b6, #8e44ad);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      display: block;
      text-align: center;
      transition: all 0.3s ease;
    }
    .file-input-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(155,89,182,0.4);
    }

    /* Progress bar */
    .progress-container {
      width: 100%;
      background: #e1e5e9;
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 20px;
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    /* Status messages */
    .status-message {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      display: none;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* Data preview table */
    .data-preview {
      margin: 15px 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      display: none;
    }
    .data-preview table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .data-preview th,
    .data-preview td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #e1e5e9;
    }
    .data-preview th {
      background: #f8f9fa;
      font-weight: 600;
    }

    /* --- Etiket kutusu (sınır çizgisi yok) --- */
    .label-preview {
      position: relative;
      width: 113.39px; /* Approx 30mm, (30mm * 3.7796px/mm) */
      height: 226.77px; /* Approx 60mm, (60mm * 3.7795px/mm) */
      background: white;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #ccc; 
    }
    .label-preview::after {
      content: "";
      position: absolute;
      bottom: 15mm; 
      left: 0;
      width: 100%;
      border-top: 1px dashed #000;
    }
    .label-content {
      width: 100%;
      padding: 4mm 1.5mm 1.5mm; 
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      box-sizing: border-box; 
    }
    .brand-section {
      width: 100%;
      margin: 0;
      padding: 0;
      text-align: center;
      margin-bottom: 2mm; 
    }
    .logo-image {
      width: 100%;
      height: auto;
      object-fit: contain;
      max-height: 30mm; 
    }
    .length-section { margin: 1mm 0; font-size: 2.8mm; } 
    .length-section span {
      display: inline-block;
      font-weight: bold;
    }
    .product-info { margin: 1mm 0; } 
    
    #renkText{
        display: inline-block;
        font-weight: bold;
        font-size: 2.8mm; 
    }
    #detayText {
      display: inline-block;
      font-weight: bold;
      margin-top: 0.5mm; 
      white-space: nowrap;
      font-size: 3mm; 
    }

    .barcode-section {
      position: absolute;
      bottom: 16mm; 
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .barcode-canvas {
      max-width: 90%;
      height: 12mm; 
      margin: 0 auto;
      display: block;
    }

    .preview-container h1 { /* Styling for "Önizleme" heading */
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }

    /* --- Yazdırma ayarları --- */
    @media print {
      body { background: white !important; margin:0 !important; padding:0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
      .container, .preview-container > h1 /* Hide main container and "Önizleme" heading only */ { display: none !important; }
      .preview-container { /* Ensure preview container itself is visible if it contains the print items */
        background: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
        max-width: none !important;
        width: auto !important;
        flex: none !important;
      }

      .label-preview-print-wrapper, .bulk-print-labels {
        display: block !important;
        margin:0 !important; padding:0 !important;
      }
      .label-preview-print-wrapper .label-preview, /* Target cloned label for single print */
      .bulk-print-labels .label-preview {
        width: 40mm !important; 
        height: 80mm !important;
        background: white !important;
        margin:0 !important; padding:0 !important;
        border: none !important;
        page-break-inside: avoid !important; /* Try to keep label content together */
      }
      .label-preview-print-wrapper .label-preview::after,
      .bulk-print-labels .label-preview::after {
        border-color:#000 !important;
        bottom: 20mm !important; 
      }
      .label-preview-print-wrapper .label-content,
      .bulk-print-labels .label-content { 
          padding:4mm 1.5mm 1.5mm !important; 
      }
      .label-preview-print-wrapper .brand-section,
      .bulk-print-labels .brand-section {
          margin-bottom: 2mm !important; 
      }
      .label-preview-print-wrapper .logo-image,
      .bulk-print-labels .logo-image {
          max-height: 35mm !important; 
      }
      .label-preview-print-wrapper .length-section,
      .bulk-print-labels .length-section { margin: 1mm 0 !important; font-size: 3.5mm !important; }
      
      .label-preview-print-wrapper #renkText, /* Target specific elements in single print */
      .bulk-print-labels #renkText { font-size: 3.5mm !important; font-weight: bold !important; }
      
      .label-preview-print-wrapper #detayText, /* Target specific elements in single print */
      .bulk-print-labels #detayText, 
      .bulk-print-labels .product-info span[id*="detayTextBulk"] /* For bulk generated IDs */
      { font-size:4mm !important; font-weight: bold !important; }
      
      .label-preview-print-wrapper .barcode-section,
      .bulk-print-labels .barcode-section {
        bottom: 21mm !important; 
      }
      .label-preview-print-wrapper .barcode-canvas,
      .bulk-print-labels .barcode-canvas {
        max-width: 90% !important;
        height: 16mm !important; 
      }
      
      .bulk-print-labels .label-preview {
        page-break-before: always !important;
        page-break-after: always !important;
      }
      .bulk-print-labels .label-preview:first-child {
        page-break-before: auto !important;
      }
      .bulk-print-labels .label-preview:last-of-type { /* Fix for extra page */
        page-break-after: auto !important;
      }
      .label-preview-print-wrapper:last-of-type { /* Fix for single print potentially adding extra page */
         page-break-after: auto !important;
      }
    }

    /* --- Mobil uyumluluk --- */
    @media (max-width: 768px) {
      body { flex-direction: column; align-items: center; }
      .container, .preview-container { max-width:100%; width:100%; }
    }

    .bulk-print-labels {
      display: none;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e1e5e9;
    }
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-logo-container">
      <img src="logo.png" alt="THE ICONE Logo" onerror="this.style.display='none'; console.error('Ana logo yüklenemedi: logo.png')">
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('single')">Tekil Etiket</button>
      <button class="tab" onclick="switchTab('bulk')">Toplu Etiket</button>
    </div>

    <div id="singleTab" class="tab-content active">
      <form id="labelForm">
        <div class="form-group">
          <label for="renk">Renk:</label>
          <input type="text" id="renk" value="Doğal" placeholder="Örn: Koyu Kahve" required>
        </div>
        <div class="form-group">
          <label for="uzunluk">Uzunluk (cm):</label>
          <input type="number" id="uzunluk" min="30" max="100" step="5" value="70" required>
        </div>
        <div class="form-group">
          <label for="gramaj">Gramaj (gr):</label>
          <input type="number" id="gramaj" min="0.1" max="2" step="0.1" value="0.8" required>
        </div>
        <div class="form-group">
          <label for="fiyat">Fiyat (TL):</label>
          <input type="number" id="fiyat" min="0" step="0.01" value="110" required>
        </div>
        <div class="form-group">
          <label for="stokNo">Stok No (Barkod için):</label>
          <input type="text" id="stokNo" placeholder="Otomatik oluşturulacak">
        </div>
      </form>
      <button class="btn preview-btn" onclick="updatePreview()">Önizleme Güncelle</button>
      <button class="btn print-btn" onclick="printLabel()">Yazdır</button>
    </div>

    <div id="bulkTab" class="tab-content">
      <h2>Excel Dosyasından Toplu Etiket</h2>
      
      <div class="form-group">
        <label>Excel Şablonunu İndir:</label>
        <button class="btn download-btn" onclick="downloadTemplate()">Şablon İndir (.xlsx)</button>
      </div>

      <div class="form-group">
        <label for="excelFile">Excel Dosyası Yükle:</label>
        <div class="file-input-wrapper">
          <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
          <label for="excelFile" class="file-input-label">📁 Excel Dosyası Seç</label>
        </div>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>

      <div class="status-message" id="statusMessage"></div>

      <div class="data-preview" id="dataPreview">
        <table id="previewTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>

      <button class="btn bulk-btn" id="bulkPrintBtn" onclick="bulkPrint()" style="display:none;">Toplu Yazdır</button>
    </div>
  </div>

  <div class="preview-container">
    <h1>Önizleme</h1>
    <div class="label-preview" id="labelPreviewHost">
      <div class="label-content">
        <div class="brand-section">
          <img id="logoImage" class="logo-image" src="logo.png" alt="THE ICONE Logo" onerror="this.style.display='none'; console.error('Etiket logosu yüklenemedi: logo.png')">
        </div>
        <div class="length-section">
          <span id="uzunlukText">70 cm</span>
        </div>
        <div class="product-info">
          <span id="renkText">Doğal</span><br>
          <span id="detayText">0.8 gr – 110 TL</span>
        </div>
        <div class="barcode-section">
          <svg class="barcode-canvas" id="barcodeCanvas"></svg>
        </div>
      </div>
    </div>
  </div>

  <div class="label-preview-print-wrapper" style="display:none;"></div>
  <div class="bulk-print-labels" id="bulkPrintLabels"></div>

  <script>
    let labelCounter = 1;
    let bulkData = [];
    const elements = ['renk','uzunluk','gramaj','fiyat','stokNo'];

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function generateStockNo(){
      const d = new Date(),
            y = d.getFullYear().toString().slice(-2), // YY
            m = String(d.getMonth()+1).padStart(2,'0'), // MM
            // day = String(d.getDate()).padStart(2,'0'), // DD - removed for 8 char
            cnt = String(labelCounter++).padStart(2,'0'); // NN (2-digit counter)
      return `IC${y}${m}${cnt}`; // ICYYMMNN - 8 characters
    }

    function updatePreview(){
      const renk   = document.getElementById('renk').value.trim(),
            uzun   = document.getElementById('uzunluk').value.trim(),
            gram   = document.getElementById('gramaj').value.trim(),
            fiyat  = document.getElementById('fiyat').value.trim(),
            stokIn = document.getElementById('stokNo');
      if(!stokIn.value.trim()) stokIn.value = generateStockNo();

      document.getElementById('uzunlukText').textContent = `${uzun||'70'} cm`;
      document.getElementById('renkText').textContent    = renk||'Doğal';
      document.getElementById('detayText').textContent   = `${gram||'0.8'} gr – ${fiyat||'110'} TL`;

      const bc = document.getElementById('barcodeCanvas'),
            no = stokIn.value.trim();
      if(bc && no){
        bc.innerHTML = ''; 
        try {
          JsBarcode(bc, no, {
            format: "CODE128",
            width: 1.5, 
            height: 45, 
            displayValue: true,
            fontSize: 10,
            textMargin: 5, 
            margin: 2,     
            background: "#fff",
            lineColor: "#000"
          });
        } catch(e){
          console.error("Barkod oluşturma hatası (önizleme):", e);
          bc.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="red" font-size="8">Barkod Hatası</text>';
        }
      } else if (bc) {
        bc.innerHTML = ''; 
      }
    }

    function printLabel(){
      updatePreview(); 
      const wrap = document.querySelector('.label-preview-print-wrapper');
      const origLabelPreviewHost = document.getElementById('labelPreviewHost');
      
      if (!origLabelPreviewHost) {
          console.error("Yazdırma için etiket önizleme elemanı bulunamadı.");
          showStatus("Yazdırma hatası: Önizleme elemanı bulunamadı.", "error");
          return;
      }
      
      const clonedLabel = origLabelPreviewHost.cloneNode(true);
      clonedLabel.removeAttribute('id'); 

      wrap.innerHTML = ''; 
      wrap.appendChild(clonedLabel);

      const printBarcodeCanvas = clonedLabel.querySelector('.barcode-canvas');
      const stockNoValue = document.getElementById('stokNo').value.trim();

      if(printBarcodeCanvas && stockNoValue){
        try {
          JsBarcode(printBarcodeCanvas, stockNoValue, {
            format: "CODE128",
            width: 1.5, 
            height: 60,  
            displayValue: true,
            fontSize: 10,
            textMargin: 5,
            margin: 2,
            background: "#fff",
            lineColor: "#000"
          });
        } catch(e){
          console.error("Barkod oluşturma hatası (yazdırma):", e);
           printBarcodeCanvas.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="red" font-size="8">Barkod Hatası</text>';
        }
      } else if (printBarcodeCanvas) {
          printBarcodeCanvas.innerHTML = ''; 
      }
      
      setTimeout(() => window.print(), 250); 
    }

    function downloadTemplate() {
      const wb = XLSX.utils.book_new();
      const wsData = [
        ['Renk', 'Uzunluk', 'Gramaj', 'Fiyat', 'StokNo (Boş bırakılırsa otomatik oluşur)'], // Updated header for clarity
        ['Doğal', 70, 0.8, 110, ''],
        ['Koyu Kahve', 65, 0.9, 120, 'IC240101'], // Example with StokNo
        ['Açık Sarı', 75, 0.7, 105, '']
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      ws['!cols'] = [
        {wch:15}, {wch:10}, {wch:10}, {wch:10}, {wch:30} // Increased width for StokNo column
      ];
      XLSX.utils.book_append_sheet(wb, ws, 'Etiketler');
      XLSX.writeFile(wb, 'etiket_sablonu.xlsx');
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message status-${type}`;
      statusEl.style.display = 'block';
      
      if (type !== 'error') { 
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, type === 'success' ? 3000 : 5000);
      }
    }

    function updateProgress(percent) {
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      
      if (percent > 0 && percent <=100) {
        progressContainer.style.display = 'block';
        progressBar.style.width = percent + '%';
        progressBar.textContent = Math.round(percent) + '%';
      } else {
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressContainer.style.display = 'none';
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      const fileInputControl = event.target; // Keep reference to the input
      if (!file) {
        updateProgress(0); 
        const label = document.querySelector('.file-input-label[for="excelFile"]');
        if (label) {
            label.textContent = '📁 Excel Dosyası Seç';
        }
        return;
      }
      
      const label = document.querySelector('.file-input-label[for="excelFile"]');
      if (label) {
          label.textContent = file.name;
      }

      showStatus('Dosya okunuyor...', 'info');
      updateProgress(10); 

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          updateProgress(30); 
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          updateProgress(50); 
          
          if (workbook.SheetNames.length === 0) {
            throw new Error('Excel dosyasında sayfa bulunamadı.');
          }
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, blankrows: false });
          
          updateProgress(70); 
          
          if (jsonData.length < 1) { 
             throw new Error('Excel dosyası boş veya başlık satırı yok.');
          }
          if (jsonData.length < 2 && jsonData[0].length > 0) { 
             showStatus('Excel dosyasında veri satırı bulunamadı, yalnızca başlıklar var.', 'info');
             bulkData = [];
             displayDataPreview(bulkData); 
             document.getElementById('bulkPrintBtn').style.display = 'none';
             updateProgress(100);
             setTimeout(() => updateProgress(0), 2000);
             fileInputControl.value = ''; // Clear file input
             return;
          }

          const headers = jsonData[0].map(h => String(h).trim());
          const rows = jsonData.slice(1);
          
          const requiredHeaders = ['Renk', 'Uzunluk', 'Gramaj', 'Fiyat']; // StokNo is optional from Excel
          const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
          
          if (missingHeaders.length > 0) {
            throw new Error(`Eksik zorunlu sütunlar: ${missingHeaders.join(', ')}. Lütfen şablonu kontrol edin.`);
          }

          bulkData = rows.map((row, rowIndex) => {
            const obj = {};
            let hasRequiredData = true;
            headers.forEach((header, index) => {
              obj[header] = row[index] !== undefined && row[index] !== null ? String(row[index]).trim() : '';
            });

            if (!obj.Renk || !obj.Uzunluk || !obj.Gramaj || !obj.Fiyat) {
                console.warn(`Satır ${rowIndex + 2} eksik zorunlu veri içeriyor, atlanıyor: Renk='${obj.Renk}', Uzunluk='${obj.Uzunluk}', Gramaj='${obj.Gramaj}', Fiyat='${obj.Fiyat}'`);
                hasRequiredData = false;
            }
            
            if (!hasRequiredData) return null; 

            // Use StokNo from Excel if provided and valid, otherwise generate
            const stokNoFromExcel = obj.StokNo ? String(obj.StokNo).trim() : '';
            if (!stokNoFromExcel) { // If StokNo is empty or not present in Excel
              obj.StokNo = generateStockNo();
            } else {
              obj.StokNo = stokNoFromExcel; // Use the one from Excel
            }
            return obj;
          }).filter(row => row !== null); 

          updateProgress(90); 
          
          if (bulkData.length === 0) {
            throw new Error('Excel dosyasında geçerli veri satırı bulunamadı veya zorunlu alanlar eksik.');
          }

          displayDataPreview(bulkData);
          document.getElementById('bulkPrintBtn').style.display = 'block';
          showStatus(`${bulkData.length} etiket başarıyla yüklendi!`, 'success');
          
          updateProgress(100);
          setTimeout(() => updateProgress(0), 2000); 

        } catch (error) {
          console.error("Dosya yükleme hatası:", error);
          updateProgress(0); 
          showStatus('Hata: ' + error.message, 'error');
          document.getElementById('bulkPrintBtn').style.display = 'none';
          bulkData = []; 
          displayDataPreview(bulkData); 
          const fileInputLabel = document.querySelector('.file-input-label[for="excelFile"]');
          if (fileInputLabel) fileInputLabel.textContent = '📁 Excel Dosyası Seç'; 
        } finally {
            fileInputControl.value = ''; // Clear file input so same file can be re-uploaded
        }
      };
      reader.onerror = function() {
          updateProgress(0);
          showStatus('Dosya okuma hatası oluştu.', 'error');
          console.error("FileReader hatası:", reader.error);
          const fileInputLabel = document.querySelector('.file-input-label[for="excelFile"]');
          if (fileInputLabel) fileInputLabel.textContent = '📁 Excel Dosyası Seç'; 
          fileInputControl.value = ''; // Clear file input
      };
      reader.readAsArrayBuffer(file);
    }

    function displayDataPreview(data) {
      const previewDiv = document.getElementById('dataPreview');
      const table = document.getElementById('previewTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      thead.innerHTML = ''; 
      tbody.innerHTML = ''; 

      if (!data || data.length === 0) {
        previewDiv.style.display = 'none';
        return;
      }

      const headers = Object.keys(data[0]);
      thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

      tbody.innerHTML = data.map(row => 
        '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>'
      ).join('');

      previewDiv.style.display = 'block';
    }

    function createLabelElement(data) {
      const labelDiv = document.createElement('div');
      labelDiv.className = 'label-preview'; 
      // Using unique IDs for text elements in bulk print might be complex if we need to target them specifically later.
      // For now, relying on class structure for print CSS.
      labelDiv.innerHTML = `
        <div class="label-content">
          <div class="brand-section">
            <img class="logo-image" src="logo.png" alt="THE ICONE Logo" onerror="this.style.display='none';">
          </div>
          <div class="length-section">
            <span style="font-weight: bold;">${data.Uzunluk || ''} cm</span>
          </div>
          <div class="product-info">
            <span id="renkTextBulk_${data.StokNo}" style="font-weight: bold;">${data.Renk || ''}</span><br> 
            <span id="detayTextBulk_${data.StokNo}" style="font-weight: bold; margin-top: 0.5mm; white-space: nowrap; font-size: 3mm;">${data.Gramaj || ''} gr – ${data.Fiyat || ''} TL</span>
          </div>
          <div class="barcode-section">
            <svg class="barcode-canvas"></svg>
          </div>
        </div>
      `;

      const barcodeEl = labelDiv.querySelector('.barcode-canvas');
      if (data.StokNo) {
        try {
          JsBarcode(barcodeEl, data.StokNo, {
            format: "CODE128",
            width: 1.5,
            height: 60, 
            displayValue: true,
            fontSize: 10,
            textMargin: 5,
            margin: 2,
            background: "#fff",
            lineColor: "#000"
          });
        } catch(e) {
          console.error("Toplu yazdırma için barkod oluşturma hatası:", data.StokNo, e);
          barcodeEl.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="red" font-size="8">Hata</text>';
        }
      }
      return labelDiv;
    }

    function bulkPrint() {
      if (bulkData.length === 0) {
        showStatus('Yazdırılacak veri bulunamadı.', 'error');
        return;
      }

      showStatus(`Yazdırma hazırlanıyor (${bulkData.length} etiket)...`, 'info');
      updateProgress(10);
      
      const bulkPrintContainer = document.getElementById('bulkPrintLabels');
      bulkPrintContainer.innerHTML = ''; 

      let processedCount = 0;
      const chunkSize = 20; // Reduced chunk size for potentially better UI responsiveness during generation
      function processChunk() {
          const chunk = bulkData.slice(processedCount, processedCount + chunkSize);
          chunk.forEach((data) => {
              const labelElement = createLabelElement(data);
              bulkPrintContainer.appendChild(labelElement);
          });
          processedCount += chunk.length;
          // Ensure progress calculation is safe
          const progressPercent = bulkData.length > 0 ? (processedCount / bulkData.length) * 100 : 0;
          updateProgress(progressPercent);


          if (processedCount < bulkData.length) {
              setTimeout(processChunk, 30); // Slightly adjusted delay
          } else {
              showStatus(`${bulkData.length} etiket yazdırma için hazırlandı.`, 'success');
              setTimeout(() => {
                  updateProgress(0); 
                  window.print();
              }, 500); 
          }
      }
      processChunk();
    }

    window.addEventListener('load', () => {
      elements.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', updatePreview);
      });
      setTimeout(updatePreview, 100); 

      if (typeof JsBarcode === 'undefined') {
        console.error('JsBarcode kütüphanesi yüklenemedi.');
        showStatus('HATA: Barkod kütüphanesi yüklenemedi! Sayfayı yenileyin.', 'error');
      }
      if (typeof XLSX === 'undefined') {
        console.error('XLSX kütüphanesi yüklenemedi.');
        showStatus('HATA: Excel kütüphanesi yüklenemedi! Sayfayı yenileyin.', 'error');
      }
    });
  </script>
</body>
</html>


